# ファームウェアをビルドする

- [環境構築](#環境構築)
  - [ファームウェアのリポジトリをクローンする](#ファームウェアのリポジトリをクローンする)
- [ビルドする](#ビルドする)
  - [uf2ファイルを生成する](#uf2ファイルを生成する)
- [生成したファームウェアを書き込む](#生成したファームウェアを書き込む)
  - [ブートローダの起動](#ブートローダの起動)
  - [ファームウェアの書き込み](#ファームウェアの書き込み)
- [設定ファイルの書き込み](#設定ファイルの書き込み)

## 環境構築

導入手順はQMKとほとんど同様です。基本的にはQMKの導入手順にしたがって必要ソフトをインストールしてください。


### ファームウェアのリポジトリをクローンする

- QMK公式のqmk_firmwareリポジトリとは別にBLE Micro Pro用のリポジトリをクローンする必要があります。
- ここでは `qmk_firmware_bmp_vial` という名前でクローンします。

``` 
git clone --depth 1 -b dev/ble-micro-pro https://github.com/sekigon-gonnoc/vial-qmk.git qmk_firmware_bmp_vial
```

uf2ではなくnrfutilを使って書き込む場合、追加でnrfutilをインストールします。

```
pip install nrfutil --user
```

## ビルドする

### uf2ファイルを生成する

以下のコマンドでuf2ファイルが生成されます。

```
make ble_micro_pro:vial:uf2
```

## 生成したファームウェアを書き込む

### ブートローダの起動

- キーボードのリセットボタンを押しながらUSB接続するとブートローダが起動します
- すでにキーボードとして動作する場合には[CLI](cli.md)からdfuコマンドを送信することでも起動できます  

### ファームウェアの書き込み

拡張子が`.uf2`のファイルを使って書き込みます

- BLE Micro Proがマスストレージデバイスとして認識され、中に`INFO_UF2.TXT`があることを確認してください。このファイルがない場合、ブートローダの起動に失敗しているので再起動してください
- アップデートしたいuf2ファイルをコピーするとアップデートが始まります。アップデート中はケーブルを外さないでください
- 書き込みが完了したら一度PCから取り外してください
- 再度マウントするとuf2ファイルは消えていますが、`VERSION.TXT`を開いてアップデート完了を確認してください

## 設定ファイルの書き込み

BLE Micro Proがアプリケーションを起動している状態で設定ファイルをコピーすると自動的に書き込みが始まります。

|ファイル名|R/W|役割|
|-|-|-|
|CONFIG.BIN|RW|キーボードの設定やVialの設定・バックアップ用|
|DEFAULT.BIN|RW|EEPROMのデフォルト状態(デフォルトキーマップなど)の設定・バックアップ用|
|EEPROM.BIN|R|現在のEEPROM状態のバックアップ用|
|VERSION.TXT|R|現在のファームウェアのバージョン|
|VIALJSON.BIN|R|vial.jsonを7zで圧縮したバイナリのバックアップ用|
